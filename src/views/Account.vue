<template>
  <div>
    <form @submit.prevent>
      <label for="name"></label>
      <input
        type="text"
        id="name"
        v-model="name"
        placeholder="username"
        required
      />
      <br />
      <label for="email"></label>
      <input
        type="text"
        id="email"
        v-model="email"
        placeholder="email address"
        required
      />
      <div v-if="v$.name.$error">Email field has an error.</div>
      <br />
      <label for="password"></label>
      <input
        type="password"
        id="password"
        v-model="password"
        placeholder="password"
        required
      />
      <br />
      <button v-on:click="loginuser">Submit</button>
    </form>
  </div>
</template>

<script>
import axios from "axios"
import useVuelidate from '@vuelidate/core'
import { required, email } from '@vuelidate/validators'

export default {
  setup() {
    return { v$: useVuelidate() }
  },
  validations() {
    return {
      name: { required }, // Matches this.firstName
      email: { required, email } // Matches this.contact.email
    }
  },
  data() {
    return {
      access_token: null,
      name: null,
      email: null,
      password: null,
    }
  },


  created() {
  },
  methods: {

    getToken: async function () {
      if (this.name && this.email && this.password) {

        // validate email address
        // validat name
        //validate password

        try {

          const url = process.env.VUE_APP_API_URL + '/api/login'
          const headers = {
            "grant_type": 'client_credentials',
            "client_id": process.env.VUE_APP_CLIENT_ID,
            "client_secret": process.env.VUE_APP_CLIENT_SECRET,
            "name": this.name,
            "email": this.email,
            "password": this.password,
            "password_confirmation": this.password,
          }

          const response = await axios.post(url, headers)
          // console.log(response)
          this.access_token = response.data.token
          // console.log(this.access_token)
          /*   save received token to local and setup a timer to renew token */
          localStorage.setItem('token', this.access_token)
        }
        catch (error) {
          // handle timeout
          console.log(error)
          console.log('user credentials wrong')
        }

      } else {
        console.log('user credentials missing')
      }
    },
    loginuser() {
      /* check if local has token */

      this.access_token = localStorage.getItem('token')
      if (!this.access_token) {
        /*send init to server */

        console.log('here')
        this.getToken()
        if (localStorage.getItem('token')) {

          this.$router.push({ path: '/jobs' })

        }
      } else {
        console.log('there')
        this.$router.push({ path: '/jobs' })
      }
      this.$router.push({ path: '/' })
    },


  },
  components: {

  },

}
</script>

<style lang="scss" scoped>
</style>