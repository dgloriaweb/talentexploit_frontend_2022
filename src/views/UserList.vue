<template>
  <ul>
    <li v-for="user in users" :key="user.id">
      {{ user.name }}
      <user v-bind:user="user" />
    </li>
  </ul>
</template>

<script>
import User from "./User.vue"
import axios from "axios"

export default {
  name: "UserList",
  data() {
    return {
      users: [],
      access_token: null,

    }
  },
  created() {
    this.getuserdata()
  },
  methods: {

  getToken: async function () {

      try {

        const url = process.env.VUE_APP_API_URL+'/api/login'
        const headers = {
          "grant_type": 'client_credentials',
          "client_id": process.env.VUE_APP_CLIENT_ID,
          "client_secret":process.env.VUE_APP_CLIENT_SECRET,
          "name":process.env.VUE_APP_UNAME,
          "email":process.env.VUE_APP_UEMAIL,
          "password":process.env.VUE_APP_UPASSWORD,
          "password_confirmation":process.env.VUE_APP_UPASSWORD,
        }

        const response = await axios.post(url, headers)
        // console.log(response)
        this.access_token = response.data.token
        // console.log(this.access_token)
        /*   save received token to local and setup a timer to renew token */
        localStorage.setItem('token', this.access_token)
      }
      catch (error) {
        // handle timeout
        console.log(error)
      }
    },
    /* token is stored, need to get the list of users  */
    getUsers: async function () {
      const config = {
        method: 'get',
        url: 'https://talentexploit.com/api/users',
        headers: {
          Authorization: `Bearer ` + this.access_token,
        }

      }
      console.log(config)
      try {
        const response = await axios(config)
        console.log(response)
        this.users = response.data
      }
      catch (error) {
        // handle timeout
        console.log(error)
      }
    },

    getuserdata() {
      /* check if local has token */
      this.access_token = localStorage.getItem('token')
      if (!this.access_token) {
        /*send init to server */

        this.getToken()

      } else {

        /* send init to server with token */

        /* get response */
        this.getUsers()

      }
    }

  },
  components: {
    User
  },
};
</script>

<style lang="scss" scoped>
</style>