<template>
  {{ users }}
  <ul>
    <li v-for="user in users" :key="user.id">
      {{ user.user_name }}
      <user v-bind:user="user" />
    </li>
  </ul>
</template>

<script>
import User from "./User.vue";
import axios from "axios";

export default {
  name: "UserList",
  message: null,
  data() {
    return {
      users: [],
      access_token: null,

    }
  },
  created() {
    this.getuserdata();
  },
  methods: {
    /* get token */
    // getToken: async function () {
    //   try {
    //     const headers = {
    //      grant_type: "client_credentials",
    //       client_id: process.env.CLIENT_ID,
    //       client_secret: process.env.CLIENT_SECRET,
    //         name: process.env.USER_NAME,
    //        email: process.env.USER_EMAIL,
    //        password: process.env.USER_PASSWORD,
    //        password_confirmation: process.env.USER_PASSWORD,
    //     }
    //     const response = await axios.post(process.env('API_URL').'/oauth/token', headers)
    //     this.access_token = response.data.access_token
    //     console.log(this.access_token)
    //     /*   save received token to local and setup a timer to renew token */
    //     localStorage.setItem('token', this.access_token)

    //     /* start session or resume session */
    //   }
    //   catch (error) {
    //     console.log(error)
    //   }
    // },

    /* user is not logged in no token present */
    // getToken: async function () {

    //   try {

    //     const url = 'https://talentexploit.com/oauth/token'
    //     const headers = {
    //       "grant_type": 'client_credentials',
    //       "client_id": "7",
    //       "client_secret": "LH20Z1YJiPMg9V8hbMaX7MqhBlKlgWLCKauQGCvH",
    //     }

    //     const response = await axios.post(url, headers)
    //     console.log(response)
    //     this.access_token = response.data.access_token
    //     console.log(response.data)
    //     /*   save received token to local and setup a timer to renew token */
    //     localStorage.setItem('token', this.access_token)
    //   }
    //   catch (error) {
    //     // handle timeout
    //     console.log(error)
    //   }
    // },
  getToken: async function () {

      try {

        const url = process.env.VUE_APP_API_URL+'/api/login'
        const headers = {
          "grant_type": 'client_credentials',
          "client_id": process.env.VUE_APP_CLIENT_ID,
          "client_secret":process.env.VUE_APP_CLIENT_SECRET,
          "name":process.env.VUE_APP_UNAME,
          "email":process.env.VUE_APP_UEMAIL,
          "password":process.env.VUE_APP_UPASSWORD,
          "password_confirmation":process.env.VUE_APP_UPASSWORD,
        }

        const response = await axios.post(url, headers)
        // console.log(response)
        this.access_token = response.data.token
        // console.log(this.access_token)
        /*   save received token to local and setup a timer to renew token */
        localStorage.setItem("token", this.access_token);
      } catch (error) {
        // handle timeout
        console.log(error);
      }
    },
    /* token is stored, need to get the list of users  */
    getUsers: async function () {
      const config = {
        method: "get",
        url: process.env("API_URL") + "/api/users",
        headers: {
          Authorization: `Bearer ` + this.access_token,
        },
      };
      console.log(config);
      try {
        const response = await axios(config);
        console.log(response);
      } catch (error) {
        // handle timeout
        console.log(error);
      }
    },

    getuserdata() {
      /* check if local has token */
      this.access_token = localStorage.getItem("token");
      if (!this.access_token) {
        /*send init to server */

        this.getToken();
        if (!this.access_token) {
          this.message = "error assigning token";
        } else {
          this.message = "token assigned";
        }
      } else {
        /* send init to server with token */

        /* get response */
        this.getUsers();
      }
    },
  },
  components: {
    User,
  },
};
</script>

<style lang="scss" scoped></style>
