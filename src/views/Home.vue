<template>
  <Ooops :ooopsMessage="ooopsMessage" :ooopsMessageType="ooopsMessageType" />
  <h1>List of Recommended Jobs</h1>
  <div id="myGridContainer">
    <div id="myGridColumn" v-if="match_rates">
      <h2>Your Personal Preferences</h2>
      <div id="ratesContainer">
        <div v-for="job in match_rates" :key="job.id" id="myGridRow">
          <div class="grid-cell-1">
            <router-link :to="{ name: 'Job Detail', params: { id: job.id } }">{{
              job.job_name
            }}</router-link>
          </div>
          <div class="grid-cell-2">
            {{ job.job_rate }}
          </div>
        </div>
      </div>
    </div>
    <div id="myGridColumn" v-if="personUpdated">
      <h2>List of your preferences/settings</h2>

      <div id="settingsContainer">
        <div class="grid-cell-1">
          <h3>Usual work location</h3>

          <input
            :myClass="{ 'red-text': isDirty['workplace'] }"
            type="checkbox"
            name="workplace"
            id="workplaceChk"
            v-model="personUpdated.workplace"
          />
          <label for="workplaceChk">I want to work at the workplace</label>
          <br />
          <input
            :myClass="{ 'red-text': isDirty['remote'] }"
            type="checkbox"
            name="remote"
            id="remoteChk"
            v-model="personUpdated.remote"
          />
          <label for="workplaceChk">I want to work remotely</label>
          <br />
          <h3>Usual working days</h3>
          <div>
            want to work workdays only:
            {{ personUpdated.workdays ? "yes" : "no" }}
          </div>
          <div>
            Can do Saturdays too: {{ personUpdated.saturday ? "yes" : "no" }}
          </div>
          <div>
            Can do Sundays too: {{ personUpdated.sunday ? "yes" : "no" }}
          </div>
          <div>
            Can do bank holidays too:
            {{ personUpdated.bank_holidays ? "yes" : "no" }}
          </div>
          <h4>Special working days</h4>
          <div>
            want to work only Saturdays, Sundays and Bank holidays:
            {{ personUpdated.sat_sun_bh_only ? "yes" : "no" }}
          </div>

          <h3>Usual working hours</h3>
          <div>
            Normal hours: {{ personUpdated.normal_hours ? "yes" : "no" }}
          </div>
          <div>
            Can do nightshift: {{ personUpdated.nightshift ? "yes" : "no" }}
          </div>
          <div>
            Can do other shift: {{ personUpdated.other_shift ? "yes" : "no" }}
          </div>
          <h4>Special working hours</h4>
          <div>
            want to do nightshift only:
            {{ personUpdated.nightshift_only ? "yes" : "no" }}
          </div>
          <div>
            want to do ther shift only (eg. late afternoons):
            {{ personUpdated.other_shift_only ? "yes" : "no" }}
          </div>
          <h3>Other</h3>
          <div>
            Take jobs that has overtime:
            {{ personUpdated.overtime ? "yes" : "no" }}
          </div>
        </div>

        <button @click="confirmPersonSettingChanges()">Store settings</button>
      </div>
    </div>
  </div>
</template>

<script>
import jobService from '../services/job.service'
import personService from '../services/person.service'
import Ooops from '../components/Ooops.vue'
// import axios from "axios"

export default {
  name: "Home",
  components: {
    Ooops
  },
  data() {
    return {
      selected: true,
      successful: false,
      match_rates: null,
      content: null,
      person: null,
      personUpdated: null,
      isDirty: {
        workplace: false,
        remote: false,
      },
      ooopsMessage: null,
      myObject: {
        workplace: true
      },
      mycheck: null,
    }
  },
  created() {
    this.fetchData()

  },
  methods: {
    fetchData() {
      jobService.getMyJobs().then(
        (response) => {
          this.content = response
          this.match_rates = this.content.data.all_job_match_rates
          this.personUpdated = response.data.person
          //take result and make a copy to use in the template, so that it can be compared if any changes.

          this.person = JSON.parse(JSON.stringify(response.data.person)) //original api values

          // ** change all numeric values to true or false would make errors in id fields. Exclude these.
          // this results an array like ['nightshift_only', 0]
          Object.entries(this.personUpdated).forEach((entry) => {
            if (entry[0] == "user_id" || entry[0] == "id") {
              return
            }
            else {
              this.personUpdated[entry[0]] = (entry[1] == 1) ? true : false
            }
          })
        })
        .catch(error => {
          if (this.content == "Network error") {
            this.ooopsMessage = "API server error"
            this.ooopsMessageType = "danger"
          }
          else if (this.content == "401") {
            this.ooopsMessage = "Unauthenticated"
            this.ooopsMessageType = "danger"
          }
          else {
            this.ooopsMessage = error.toString()
            this.ooopsMessageType = "danger"
          }
        })
    },
    clearDirty() {
      Object.keys(this.isDirty).forEach((value) => {
        this.isDirty[value] = false
      })

    },
    checkClicked(e) {
      this.$nextTick(() => {
        //check if the status of this checkbox is the same as the person data
        //if it is, and class is applied, remove it
        var chkboxName = e.srcElement.name

        // mark with color if different than array value
        if (e.srcElement.checked == this.person.workplace) {
          this.isDirty[chkboxName] = false
        }
        //if it's not, then let's change the class of the checkbox
        else {
          this.isDirty[chkboxName] = true
        }
        // var selection = (e.srcElement.value == "on") ? 1 : 0
        // //make a copy of the person array and add changes to it
        // //TODO folyt kov innen, objectben itemet felulirni. 
        // console.log(this.personUpdated);
        // this.personUpdated == null ? (this.personUpdated = this.person) : (this.personUpdated[chkboxName] = selection)
      })
    },
    confirmPersonSettingChanges() {
      // show a modal
      // show list of dirty fields
      // var myresultObject = Object.keys(this.isDirty).filter((value) => this.isDirty[value] == true)

      // if (myresultObject.length == 0) {
      // alert('no changes.')
      // } else {
      //TODO replace with designed modal
      // var confirmChanges = confirm("Do you want to save these changes: \n\n")
      // if (confirmChanges) {
      // use service to alter person data
      this.storePersonData()
      this.ooopsMessage = "data updated successfully"
            this.ooopsMessageType = "success"
      // }
      // }
    },
    storePersonData() {
      // change every true and false back to 0  and 1 

      personService.updatePerson(this.personUpdated).then(
        () => {
          this.fetchData()
          this.clearDirty()
        })
        .catch(error => {
          // this.error = error?.response?.data?.message ?? error.message ?? error
          this.ooopsMessage = error
        })
    }
  },
}
</script>

<style  scoped>
#myGridContainer {
  background: rgb(53, 52, 52);
  width: fit-content;
  display: flex;
  gap: 35px;
}
#myGridColumn {
  padding: 15px;
}
#myGridRow {
  display: grid;
  grid-template-columns: 3fr 1fr;
  padding: 10px;
}
#ratesContainer,
#settingsContainer {
  background: grey;
}
.grid-cell-1 {
  width: max-content;
}
.grid-cell-2 {
  text-align: right;
}
.grid-cell-2:after {
  content: "%";
}
</style>